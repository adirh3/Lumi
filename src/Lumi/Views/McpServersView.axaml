<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lumi.ViewModels"
             xmlns:models="using:Lumi.Models"
             xmlns:loc="using:Lumi.Localization"
             x:Class="Lumi.Views.McpServersView"
             x:DataType="vm:McpServersViewModel"
             x:CompileBindings="True">

  <UserControl.Styles>
    <Style Selector="ScrollViewer.motion-surface, StackPanel.motion-surface">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.18" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="ScrollViewer.motion-surface[IsVisible=true], StackPanel.motion-surface[IsVisible=true]">
      <Setter Property="Opacity" Value="1" />
    </Style>
    <Style Selector="Button.motion-action">
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.12" />
          <BrushTransition Property="Background" Duration="0:0:0.12" />
          <BrushTransition Property="BorderBrush" Duration="0:0:0.12" />
        </Transitions>
      </Setter>
    </Style>
  </UserControl.Styles>

  <Panel>
      <!-- Editor form -->
      <ScrollViewer Classes="motion-surface"
                    IsVisible="{Binding IsEditing}"
                    HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto" Padding="36,24,36,36">
        <StackPanel Spacing="16" MaxWidth="560">

          <!-- Header + actions row -->
          <DockPanel>
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
              <Button Classes="accent motion-action" Content="{loc:Str Common_Save}" Padding="18,7" MinHeight="0"
                      Command="{Binding SaveServerCommand}" />
              <Button Classes="subtle motion-action" Content="{loc:Str Common_Cancel}" Padding="18,7" MinHeight="0"
                      Command="{Binding CancelEditCommand}" />
              <Button Classes="subtle motion-action" Padding="10,7" MinHeight="0"
                      Command="{Binding DeleteServerCommand}"
                      CommandParameter="{Binding SelectedServer}"
                      IsVisible="{Binding SelectedServer, Converter={x:Static ObjectConverters.IsNotNull}}"
                      ToolTip.Tip="{loc:Str Menu_Delete}">
                <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14"
                          Foreground="{DynamicResource Brush.TextTertiary}" />
              </Button>
            </StackPanel>
            <TextBlock Text="{loc:Str Editor_McpServer}" FontSize="{DynamicResource Font.SizeSubtitle}" FontWeight="SemiBold"
                       VerticalAlignment="Center" />
          </DockPanel>

          <StackPanel Spacing="4">
            <TextBlock Text="{loc:Str Field_Name}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                       LetterSpacing="0.8" />
            <TextBox Text="{Binding EditName}" Watermark="{loc:Str Watermark_McpServerName}" />
          </StackPanel>

          <StackPanel Spacing="4">
            <TextBlock Text="{loc:Str Field_Description}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                       LetterSpacing="0.8" />
            <TextBox Text="{Binding EditDescription}"
                     Watermark="{loc:Str Watermark_McpServerDescription}" />
          </StackPanel>

          <StackPanel Spacing="4">
            <TextBlock Text="{loc:Str Field_ServerType}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                       LetterSpacing="0.8" />
            <ComboBox SelectedIndex="{Binding EditServerTypeIndex}" HorizontalAlignment="Stretch">
              <ComboBoxItem Content="{loc:Str McpType_Local}" />
              <ComboBoxItem Content="{loc:Str McpType_Remote}" />
            </ComboBox>
          </StackPanel>

          <!-- Local server fields -->
          <StackPanel Spacing="16" IsVisible="{Binding !EditServerTypeIndex}">
            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Str Field_Command}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                         LetterSpacing="0.8" />
              <TextBox Text="{Binding EditCommand}" Watermark="{loc:Str Watermark_McpCommand}" />
            </StackPanel>

            <!-- npx servers: read-only package + editable server args -->
            <StackPanel Spacing="16" IsVisible="{Binding IsNpxCommand}">
              <StackPanel Spacing="4">
                <TextBlock Text="PACKAGE" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                           LetterSpacing="0.8" />
                <DockPanel>
                  <Button DockPanel.Dock="Right" Classes="subtle" Padding="8,4" MinHeight="0"
                          CornerRadius="6" VerticalAlignment="Center" Margin="8,0,0,0"
                          Command="{Binding OpenNpmPageCommand}" ToolTip.Tip="Open npm page for documentation">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <PathIcon Data="{StaticResource Icon.Browse}" Width="11" Height="11"
                                Foreground="{DynamicResource Brush.TextTertiary}" />
                      <TextBlock Text="Docs" FontSize="11"
                                 Foreground="{DynamicResource Brush.TextTertiary}" />
                    </StackPanel>
                  </Button>
                  <TextBox Text="{Binding EditNpxPackage}"
                           Watermark="@modelcontextprotocol/server-filesystem" />
                </DockPanel>
              </StackPanel>

              <StackPanel Spacing="4">
                <TextBlock Text="SERVER ARGUMENTS" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                           LetterSpacing="0.8" />
                <TextBox Text="{Binding EditServerArgs}" AcceptsReturn="True" TextWrapping="Wrap"
                         MinHeight="72" MaxHeight="200"
                         VerticalContentAlignment="Top"
                         Watermark="Paths, connection strings, or other config â€” one per line" />
                <TextBlock Text="These arguments are passed to the MCP server after the package name. Check the Docs button above for what this server expects."
                           FontSize="11" Foreground="{DynamicResource Brush.TextTertiary}"
                           TextWrapping="Wrap" Margin="0,1,0,0" />
              </StackPanel>
            </StackPanel>

            <!-- Non-npx servers: single args field -->
            <StackPanel Spacing="4" IsVisible="{Binding !IsNpxCommand}">
              <TextBlock Text="{loc:Str Field_Arguments}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                         LetterSpacing="0.8" />
              <TextBox Text="{Binding EditArgs}" AcceptsReturn="True" TextWrapping="Wrap"
                       MinHeight="72" MaxHeight="200"
                       VerticalContentAlignment="Top"
                       Watermark="{loc:Str Watermark_McpArgs}" />
            </StackPanel>

            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Str Field_Environment}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                         LetterSpacing="0.8" />
              <TextBox Text="{Binding EditEnvVars}" AcceptsReturn="True" TextWrapping="Wrap"
                       MinHeight="56" MaxHeight="200"
                       VerticalContentAlignment="Top"
                       Watermark="API_KEY=your-key  (one per line)" />
            </StackPanel>
          </StackPanel>

          <!-- Remote server fields -->
          <StackPanel Spacing="16" IsVisible="{Binding EditServerTypeIndex}">
            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Str Field_Url}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                         LetterSpacing="0.8" />
              <TextBox Text="{Binding EditUrl}" Watermark="{loc:Str Watermark_McpUrl}" />
            </StackPanel>
            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Str Field_Headers}" FontSize="10" FontWeight="SemiBold" Opacity="0.5"
                         LetterSpacing="0.8" />
              <TextBox Text="{Binding EditHeaders}" AcceptsReturn="True" TextWrapping="Wrap"
                       MinHeight="56" MaxHeight="200"
                       VerticalContentAlignment="Top"
                       Watermark="Authorization=Bearer token" />
            </StackPanel>
          </StackPanel>

          <!-- Enabled toggle -->
          <DockPanel>
            <ToggleSwitch DockPanel.Dock="Right" IsChecked="{Binding EditIsEnabled}"
                          VerticalAlignment="Center" Margin="12,0,0,0"
                          OnContent="" OffContent="" />
            <StackPanel Spacing="1" VerticalAlignment="Center">
              <TextBlock Text="{loc:Str Mcp_EnabledTitle}" FontSize="{DynamicResource Font.SizeBody}" />
              <TextBlock Text="Include this server in chat sessions"
                         FontSize="{DynamicResource Font.SizeCaption}"
                         Foreground="{DynamicResource Brush.TextTertiary}" />
            </StackPanel>
          </DockPanel>

        </StackPanel>
      </ScrollViewer>

      <!-- Browse catalog -->
      <DockPanel IsVisible="{Binding IsBrowsing}">
        <StackPanel DockPanel.Dock="Top" Spacing="1" Margin="36,24,36,0">
          <TextBlock Text="{loc:Str Mcp_BrowseCatalog}" FontSize="{DynamicResource Font.SizeSubtitle}" FontWeight="SemiBold" />
          <TextBlock Text="Discover and install MCP servers from npm"
                     FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <Border DockPanel.Dock="Top" Margin="36,14,36,0">
          <TextBox Watermark="{loc:Str Mcp_SearchCatalog}" Text="{Binding BrowseSearchQuery}"
                   Padding="8,7,10,7" FontSize="{DynamicResource Font.SizeBody}">
            <TextBox.InnerLeftContent>
              <PathIcon Data="{StaticResource Icon.Search}" Width="13" Height="13"
                        Foreground="{DynamicResource Brush.TextTertiary}"
                        Margin="6,0,4,0" />
            </TextBox.InnerLeftContent>
          </TextBox>
        </Border>

        <!-- Loading indicator for npm search -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="6"
                    IsVisible="{Binding IsSearchingNpm}"
                    Margin="36,10,36,0">
          <TextBlock Text="â³" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}">
            <TextBlock.Styles>
              <Style Selector="TextBlock">
                <Style.Animations>
                  <Animation Duration="0:0:0.8" IterationCount="Infinite"
                             PlaybackDirection="Alternate" Easing="SineEaseInOut">
                    <KeyFrame Cue="0%">
                      <Setter Property="Opacity" Value="0.3" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                      <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                  </Animation>
                </Style.Animations>
              </Style>
            </TextBlock.Styles>
          </TextBlock>
          <TextBlock Text="{loc:Str Mcp_SearchingNpm}"
                     FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Auto"
                      Margin="36,14,36,24">
          <ItemsControl ItemsSource="{Binding CatalogEntries}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:McpCatalogEntry">
                <Border Background="{DynamicResource Brush.SurfaceSubtle}"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Padding="16,14" Margin="0,0,0,6"
                        BorderBrush="{DynamicResource Brush.BorderSubtle}"
                        BorderThickness="1">
                  <Border.Transitions>
                    <Transitions>
                      <BrushTransition Property="BorderBrush" Duration="0:0:0.15" />
                    </Transitions>
                  </Border.Transitions>
                  <Border.Styles>
                    <Style Selector="Border:pointerover">
                      <Setter Property="BorderBrush" Value="{DynamicResource Brush.BorderDefault}" />
                    </Style>
                  </Border.Styles>
                  <DockPanel>
                    <Button DockPanel.Dock="Right" VerticalAlignment="Center" Margin="16,0,0,0"
                            Padding="14,6" MinHeight="0" CornerRadius="8"
                            IsEnabled="{Binding !IsInstalled}"
                            Command="{Binding $parent[UserControl].((vm:McpServersViewModel)DataContext).InstallCatalogEntryCommand}"
                            CommandParameter="{Binding}">
                      <Button.Styles>
                        <Style Selector="Button:disabled">
                          <Setter Property="Opacity" Value="0.6" />
                        </Style>
                      </Button.Styles>
                      <StackPanel Orientation="Horizontal" Spacing="5">
                        <PathIcon Data="{StaticResource Icon.Check}" Width="11" Height="11"
                                  IsVisible="{Binding IsInstalled}" />
                        <TextBlock Text="{loc:Str Mcp_Install}"
                                   IsVisible="{Binding !IsInstalled}" FontWeight="Medium" />
                        <TextBlock Text="{loc:Str Mcp_Installed}"
                                   IsVisible="{Binding IsInstalled}" />
                      </StackPanel>
                    </Button>
                    <StackPanel Spacing="4">
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding Icon}" FontSize="18" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"
                                   FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                        <Border Background="{DynamicResource Brush.SurfaceRaised}"
                                CornerRadius="6" Padding="7,2" VerticalAlignment="Center">
                          <TextBlock Text="{Binding Category}" FontSize="10"
                                     Foreground="{DynamicResource Brush.TextTertiary}"
                                     FontWeight="Medium" />
                        </Border>
                      </StackPanel>
                      <TextBlock Text="{Binding Description}" FontSize="{DynamicResource Font.SizeCaption}"
                                 Foreground="{DynamicResource Brush.TextSecondary}"
                                 TextWrapping="Wrap" MaxLines="2" TextTrimming="CharacterEllipsis" />
                      <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,2,0,0">
                        <TextBlock Text="{Binding NpmPackage}" FontSize="10"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   FontFamily="Consolas,Menlo,monospace" Opacity="0.7" />
                        <TextBlock Text="{Binding DownloadsDisplay}" FontSize="10"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   IsVisible="{Binding MonthlyDownloads}" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4"
                                  IsVisible="{Binding HasRequiredEnvVars}" Margin="0,1,0,0">
                        <TextBlock Text="ðŸ”‘" FontSize="10" VerticalAlignment="Center" />
                        <TextBlock Text="Requires:" FontSize="10"
                                   Foreground="{DynamicResource Brush.TextTertiary}" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding EnvVarHint}" FontSize="10"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   FontFamily="Consolas,Menlo,monospace" />
                      </StackPanel>
                    </StackPanel>
                  </DockPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </DockPanel>

      <!-- Empty state (only shown when not editing or browsing) -->
      <StackPanel Classes="motion-surface"
                  HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10" Opacity="0.35">
        <StackPanel.IsVisible>
          <MultiBinding Converter="{x:Static BoolConverters.And}">
            <Binding Path="!IsEditing" />
            <Binding Path="!IsBrowsing" />
          </MultiBinding>
        </StackPanel.IsVisible>
        <PathIcon Data="{StaticResource Icon.Plug}" Width="28" Height="28"
                  Foreground="{DynamicResource Brush.TextSecondary}"
                  HorizontalAlignment="Center" />
        <StackPanel Spacing="2" HorizontalAlignment="Center">
          <TextBlock Text="{loc:Str Empty_SelectMcpServer}" FontSize="{DynamicResource Font.SizeBody}"
                     HorizontalAlignment="Center" />
          <TextBlock Text="Select a server to configure or browse the catalog to add new ones."
                     FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}"
                     HorizontalAlignment="Center" TextWrapping="Wrap"
                     MaxWidth="280" TextAlignment="Center" />
        </StackPanel>
      </StackPanel>
  </Panel>
</UserControl>
