<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Lumi.ViewModels"
        xmlns:views="using:Lumi.Views"
        xmlns:sc="using:StrataTheme.Controls"
        xmlns:models="using:Lumi.Models"
        xmlns:loc="using:Lumi.Localization"
        x:Class="Lumi.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        x:CompileBindings="True"
        Title="Lumi"
        Width="1320" Height="860"
        MinWidth="800" MinHeight="560"
        WindowStartupLocation="CenterScreen"
        TransparencyLevelHint="AcrylicBlur,Blur"
        UseLayoutRounding="True"
        Background="Transparent">

  <Window.Resources>
    <Thickness x:Key="MainLayout.IslandOuterMargin">8,30,6,6</Thickness>
    <x:Double x:Key="MainLayout.SplitIslandMinWidth">220</x:Double>

    <!-- ── SVG Icon Paths ── -->
    <StreamGeometry x:Key="Icon.Chat">M4 4h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7l-4 3V6a2 2 0 0 1 2-2z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Folder">M2 6a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Bolt">M13 2L3 14h9l-1 8 10-12h-9l1-8z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Sparkle">M12 2l2.4 7.2L22 12l-7.6 2.8L12 22l-2.4-7.2L2 12l7.6-2.8L12 2z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Gear">M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm-1-8h2l.4 2.2a8 8 0 0 1 2.3 1.3l2.1-.8 1 1.7-1.7 1.4a8 8 0 0 1 0 2.4l1.7 1.4-1 1.7-2.1-.8a8 8 0 0 1-2.3 1.3L13 22h-2l-.4-2.2a8 8 0 0 1-2.3-1.3l-2.1.8-1-1.7 1.7-1.4a8 8 0 0 1 0-2.4L5.2 12.4l1-1.7 2.1.8a8 8 0 0 1 2.3-1.3L11 8z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Compose">M15.2 3.8a2.4 2.4 0 0 1 3.4 0l1.6 1.6a2.4 2.4 0 0 1 0 3.4L9 20l-5 1 1-5L15.2 3.8z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Search">M10 3a7 7 0 1 0 4.2 12.6l4.1 4.1a1 1 0 0 0 1.4-1.4l-4.1-4.1A7 7 0 0 0 10 3zm-5 7a5 5 0 1 1 10 0 5 5 0 0 1-10 0z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Plus">M12 4a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5a1 1 0 0 1 1-1z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Trash">M9 3h6a1 1 0 0 1 1 1H7a1 1 0 0 1 1-1zM4 6h16v1H4V6zm2 2h12l-1 13H7L6 8zm4 2v8h1v-8h-1zm3 0v8h1v-8h-1z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Memory">M9.5 2A1.5 1.5 0 0 0 8 3.5V4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-4v-.5A1.5 1.5 0 0 0 14.5 2h-5zM10 4V3.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V4h-4zm-2 5a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm5 0a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm-5 4a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm5 0a1 1 0 1 1 2 0 1 1 0 0 1-2 0z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Plug">M17 6.1h3V8h-3v2.1a5 5 0 0 1-4 4.9V18h2v2H9v-2h2v-3a5 5 0 0 1-4-4.9V8H4V6.1h3V4h2v2.1h4V4h2v2.1zM9 8v2.1a3 3 0 0 0 6 0V8H9z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Rename">M4 18h4l10-10a2 2 0 0 0 0-2.83l-1.17-1.17a2 2 0 0 0-2.83 0L4 14v4zm2-3.17L14.59 6.24l1.17 1.17L7.17 16H6v-1.17z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Browse">M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 10h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4zM4 16h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z</StreamGeometry>
    <StreamGeometry x:Key="Icon.Check">M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z</StreamGeometry>
  </Window.Resources>

  <Window.Styles>
    <!-- Sidebar ListBox: transparent, borderless, blends in -->
    <Style Selector="ListBox.sidebar-list">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Padding" Value="0" />
      <Setter Property="Margin" Value="0" />
    </Style>
    <Style Selector="ListBox.sidebar-list ListBoxItem">
      <Setter Property="Padding" Value="12,7" />
      <Setter Property="Margin" Value="1,0" />
      <Setter Property="MinHeight" Value="0" />
    </Style>
    <!-- Nav icon buttons: use subtle as base for reliable hit testing -->
    <Style Selector="Button.nav-icon">
      <Setter Property="Padding" Value="7" />
      <Setter Property="MinWidth" Value="0" />
      <Setter Property="MinHeight" Value="0" />
      <Setter Property="CornerRadius" Value="{DynamicResource Radius.Base}" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Focusable" Value="False" />
      <Setter Property="ToolTip.Placement" Value="Top" />
      <Setter Property="ToolTip.VerticalOffset" Value="-4" />
    </Style>
    <Style Selector="Button.nav-icon.active">
      <Setter Property="Background" Value="{DynamicResource Brush.AccentSubtle}" />
    </Style>
    <Style Selector="Button.nav-icon.active:pointerover /template/ Border#PART_Surface">
      <Setter Property="Background" Value="{DynamicResource Brush.AccentSubtleHover}" />
    </Style>

    <Style Selector="Button.project-pill">
      <Setter Property="Padding" Value="10,4" />
      <Setter Property="MinHeight" Value="0" />
      <Setter Property="MinWidth" Value="0" />
      <Setter Property="CornerRadius" Value="12" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Focusable" Value="False" />
    </Style>

    <Style Selector="ScrollViewer.hover-scroll ScrollBar">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="ScrollViewer.hover-scroll:pointerover ScrollBar">
      <Setter Property="Opacity" Value="1" />
    </Style>

  </Window.Styles>

  <Border x:Name="WindowContentRoot">
  <Panel>
    <!-- Semi-transparent background that lets Mica/Acrylic show through -->
    <Border x:Name="AcrylicFallback" IsHitTestVisible="False">
      <Border.Background>
        <SolidColorBrush Color="{DynamicResource Color.Background}" Opacity="0.8" />
      </Border.Background>
    </Border>

    <!-- ═══ Onboarding Overlay ═══ -->
    <Panel x:Name="OnboardingPanel" IsVisible="True">
      <Border Background="{DynamicResource Brush.Background}" Opacity="0.5" />
      <Border HorizontalAlignment="Center" VerticalAlignment="Center"
              Classes="strata-card" Padding="52,44" MaxWidth="420" MinWidth="360">
        <StackPanel Spacing="28" HorizontalAlignment="Stretch">

          <!-- ── Branding ── -->
          <StackPanel Spacing="10" HorizontalAlignment="Center">
            <Border Width="64" Height="64" CornerRadius="32"
                    Background="{DynamicResource Brush.AccentGradient}"
                    HorizontalAlignment="Center">
              <Image Source="/Assets/lumi-icon.png" Width="40" Height="40"
                     RenderOptions.BitmapInterpolationMode="HighQuality"
                     HorizontalAlignment="Center" VerticalAlignment="Center" />
            </Border>
            <TextBlock Classes="headline" Text="{loc:Str Onboarding_Hello}"
                       HorizontalAlignment="Center" Margin="0,4,0,0" />
            <TextBlock Classes="secondary" Text="{loc:Str Onboarding_Subtitle}"
                       HorizontalAlignment="Center" TextAlignment="Center"
                       TextWrapping="Wrap" MaxWidth="300" />
          </StackPanel>

          <!-- ── Form ── -->
          <StackPanel Spacing="10">
            <TextBox Watermark="{loc:Str Onboarding_NameWatermark}"
                     Text="{Binding OnboardingName}" HorizontalAlignment="Stretch" />

            <!-- Sex + Language side by side -->
            <Grid ColumnDefinitions="*,8,*">
              <ComboBox x:Name="OnboardingSexCombo" Grid.Column="0"
                        HorizontalAlignment="Stretch"
                        SelectedIndex="{Binding OnboardingSexIndex}" />
              <ComboBox x:Name="OnboardingLanguageCombo" Grid.Column="2"
                        HorizontalAlignment="Stretch"
                        SelectedIndex="{Binding OnboardingLanguageIndex}" />
            </Grid>

            <!-- Dark mode toggle -->
            <Border CornerRadius="{DynamicResource Radius.Base}"
                    Background="{DynamicResource Brush.SurfaceSubtle}"
                    Padding="14,8">
              <DockPanel>
                <ToggleSwitch DockPanel.Dock="Right" IsChecked="{Binding IsDarkTheme}"
                              VerticalAlignment="Center" Margin="12,0,0,0"
                              OnContent="" OffContent="" />
                <StackPanel VerticalAlignment="Center">
                  <TextBlock Text="{loc:Str Onboarding_DarkMode}"
                             FontWeight="Medium" />
                </StackPanel>
              </DockPanel>
            </Border>
          </StackPanel>

          <!-- ── Go button ── -->
          <Button Classes="accent" Content="{loc:Str Onboarding_LetsGo}"
                  Command="{Binding CompleteOnboardingCommand}"
                  HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                  Padding="12,10" FontWeight="SemiBold" />
        </StackPanel>
      </Border>
    </Panel>

    <!-- ═══ Main App ═══ -->
    <DockPanel x:Name="MainPanel" IsVisible="False">

      <!-- ═══ ALWAYS-VISIBLE LEFT SIDEBAR ═══ -->
      <Border x:Name="SidebarBorder" DockPanel.Dock="Left" Width="240">
        <DockPanel>

          <!-- ── Top: Title bar inset (respects window chrome) ── -->
          <Border DockPanel.Dock="Top" IsHitTestVisible="False" Height="30" />

          <!-- ── Bottom: Nav row ── -->
          <Border DockPanel.Dock="Bottom">
            <StackPanel x:Name="NavRow" Orientation="Horizontal" Spacing="0"
                        Margin="14,6,14,8">
              <Button Classes="subtle nav-icon" x:Name="NavChat" ToolTip.Tip="{loc:Str Nav_Chats}"
                      Command="{Binding SetNavCommand}" CommandParameter="0">
                <PathIcon Data="{StaticResource Icon.Chat}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavProjects" ToolTip.Tip="{loc:Str Nav_Projects}"
                      Command="{Binding SetNavCommand}" CommandParameter="1">
                <PathIcon Data="{StaticResource Icon.Folder}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavSkills" ToolTip.Tip="{loc:Str Nav_Skills}"
                      Command="{Binding SetNavCommand}" CommandParameter="2">
                <PathIcon Data="{StaticResource Icon.Bolt}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavAgents" ToolTip.Tip="{loc:Str Nav_Lumis}"
                      Command="{Binding SetNavCommand}" CommandParameter="3">
                <PathIcon Data="{StaticResource Icon.Sparkle}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavMemories" ToolTip.Tip="{loc:Str Nav_Memories}"
                      Command="{Binding SetNavCommand}" CommandParameter="4">
                <PathIcon Data="{StaticResource Icon.Memory}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavMcpServers" ToolTip.Tip="{loc:Str Nav_McpServers}"
                      Command="{Binding SetNavCommand}" CommandParameter="5">
                <PathIcon Data="{StaticResource Icon.Plug}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
              <Button Classes="subtle nav-icon" x:Name="NavSettings" ToolTip.Tip="{loc:Str Nav_Settings}"
                      Command="{Binding SetNavCommand}" CommandParameter="6">
                <PathIcon Data="{StaticResource Icon.Gear}" Width="16" Height="16"
                          Foreground="{DynamicResource Brush.TextSecondary}" />
              </Button>
            </StackPanel>
          </Border>

          <!-- ═══ SIDEBAR CONTENT PANELS (one per tab, wrapped for DockPanel fill) ═══ -->
          <Panel>

          <!-- ── 0: Chat sidebar ── -->
          <Panel x:Name="SidebarChat">
            <DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,4,16,0">
                <Button Classes="subtle" HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Padding="10,8" MinHeight="0"
                        ToolTip.Tip="{loc:Str Sidebar_NewChatTooltip}"
                        Command="{Binding NewChatCommand}"
                        Click="NewChatButton_Click">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="{StaticResource Icon.Compose}" Width="13" Height="13"
                              Foreground="{DynamicResource Brush.AccentDefault}" />
                    <TextBlock Text="{loc:Str Sidebar_NewChat}" FontWeight="Medium"
                               Foreground="{DynamicResource Brush.TextSecondary}"
                               VerticalAlignment="Center" />
                  </StackPanel>
                </Button>
              </Border>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" x:Name="ChatSearchBox"
                         Text="{Binding ChatSearchQuery, Mode=TwoWay}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <!-- ── Project filter pills ── -->
              <Border DockPanel.Dock="Top" Margin="10,6,10,0"
                      IsVisible="{Binding Projects.Count}">
                <ScrollViewer HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled"
                              Classes="scroll-fade">
                  <StackPanel x:Name="ProjectFilterBar" Orientation="Horizontal" Spacing="4" />
                </ScrollViewer>
              </Border>
              <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                            Classes="hover-scroll" Margin="0,8,0,0">
                <ItemsControl x:Name="ChatGroupsHost" ItemsSource="{Binding ChatGroups}" Margin="6,0,6,8">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <StackPanel x:DataType="vm:ChatGroup" Margin="0,0,0,2">
                        <TextBlock Text="{Binding Label}" FontSize="{DynamicResource Font.SizeCaption}" FontWeight="SemiBold"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   Margin="10,10,0,4" />
                        <ListBox Classes="sidebar-list chat-list"
                                 ItemsSource="{Binding Chats}"
                                 SelectionMode="Single"
                                 SelectedItem="{x:Null}"
                                 ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                          <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="models:Chat">
                              <Panel Background="Transparent">
                                <Panel.ContextMenu>
                                  <ContextMenu x:CompileBindings="False">
                                    <MenuItem Header="{loc:Str Menu_Rename}"
                                              Command="{Binding $parent[Window].DataContext.StartRenameChatCommand}"
                                              CommandParameter="{Binding}">
                                      <MenuItem.Icon>
                                        <PathIcon Data="{StaticResource Icon.Rename}" Width="14" Height="14" />
                                      </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem x:Name="MoveToProjectMenu" Header="{loc:Str Menu_MoveToProject}">
                                      <MenuItem.Icon>
                                        <PathIcon Data="{StaticResource Icon.Folder}" Width="14" Height="14" />
                                      </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="{loc:Str Menu_RemoveFromProject}"
                                              Command="{Binding $parent[Window].DataContext.RemoveChatFromProjectCommand}"
                                              CommandParameter="{Binding}"
                                              IsVisible="{Binding ProjectId, Converter={x:Static ObjectConverters.IsNotNull}}">
                                      <MenuItem.Icon>
                                        <PathIcon Data="{StaticResource Icon.Folder}" Width="14" Height="14" />
                                      </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator />
                                    <MenuItem Header="{loc:Str Menu_Delete}"
                                              Command="{Binding $parent[Window].DataContext.DeleteChatCommand}"
                                              CommandParameter="{Binding}">
                                      <MenuItem.Icon>
                                        <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                                      </MenuItem.Icon>
                                    </MenuItem>
                                  </ContextMenu>
                                </Panel.ContextMenu>
                                <DockPanel>
                                  <TextBlock DockPanel.Dock="Bottom"
                                             x:Name="ProjectLabel"
                                             FontSize="10"
                                             Foreground="{DynamicResource Brush.AccentDefault}"
                                             Opacity="0.7"
                                             TextTrimming="CharacterEllipsis"
                                             IsVisible="False" />
                                  <TextBlock Text="{Binding Title}"
                                             ToolTip.Tip="{Binding Title}"
                                             TextTrimming="CharacterEllipsis"
                                             VerticalAlignment="Center" />
                                </DockPanel>
                              </Panel>
                            </DataTemplate>
                          </ListBox.ItemTemplate>
                        </ListBox>
                      </StackPanel>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </DockPanel>
          </Panel>

          <!-- ── 1: Projects sidebar ── -->
          <Panel x:Name="SidebarProjects" IsVisible="False" DataContext="{Binding ProjectsVM}" x:DataType="vm:ProjectsViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="7,5" MinHeight="0"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Command="{Binding NewProjectCommand}" ToolTip.Tip="{loc:Str Sidebar_NewProjectTooltip}">
                  <PathIcon Data="{StaticResource Icon.Plus}" Width="14" Height="14"
                            Foreground="{DynamicResource Brush.TextSecondary}" />
                </Button>
                <TextBlock Text="{loc:Str Sidebar_Projects}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="8,8,8,8"
                       ItemsSource="{Binding Projects}"
                       SelectedItem="{Binding SelectedProject, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="models:Project">
                    <Panel Background="Transparent">
                      <Panel.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="{loc:Str Menu_Delete}"
                                    Command="{Binding $parent[Window].DataContext.ProjectsVM.DeleteProjectCommand}"
                                    CommandParameter="{Binding}">
                            <MenuItem.Icon>
                              <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                            </MenuItem.Icon>
                          </MenuItem>
                        </ContextMenu>
                      </Panel.ContextMenu>
                      <DockPanel>
                        <TextBlock x:Name="ProjectChatCount" DockPanel.Dock="Right"
                                   FontSize="{DynamicResource Font.SizeCaption}" Foreground="{DynamicResource Brush.TextTertiary}"
                                   VerticalAlignment="Center" Margin="4,0,0,0" />
                        <StackPanel Spacing="1">
                          <TextBlock Text="{Binding Name}" FontSize="{DynamicResource Font.SizeBody}" TextTrimming="CharacterEllipsis" />
                          <TextBlock FontSize="{DynamicResource Font.SizeCaption}" Foreground="{DynamicResource Brush.TextTertiary}"
                                     Text="{Binding CreatedAt, StringFormat='{}{0:MMM d, yyyy}'}" />
                        </StackPanel>
                      </DockPanel>
                    </Panel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </DockPanel>
          </Panel>

          <!-- ── 2: Skills sidebar ── -->
          <Panel x:Name="SidebarSkills" IsVisible="False" DataContext="{Binding SkillsVM}" x:DataType="vm:SkillsViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="7,5" MinHeight="0"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Command="{Binding NewSkillCommand}" ToolTip.Tip="{loc:Str Sidebar_NewSkillTooltip}">
                  <PathIcon Data="{StaticResource Icon.Plus}" Width="14" Height="14"
                            Foreground="{DynamicResource Brush.TextSecondary}" />
                </Button>
                <TextBlock Text="{loc:Str Sidebar_Skills}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="8,8,8,8"
                       ItemsSource="{Binding Skills}"
                       SelectedItem="{Binding SelectedSkill, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="models:Skill">
                    <Panel Background="Transparent">
                      <Panel.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="{loc:Str Menu_Delete}"
                                    Command="{Binding $parent[Window].DataContext.SkillsVM.DeleteSkillCommand}"
                                    CommandParameter="{Binding}">
                            <MenuItem.Icon>
                              <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                            </MenuItem.Icon>
                          </MenuItem>
                        </ContextMenu>
                      </Panel.ContextMenu>
                      <StackPanel Spacing="1">
                        <TextBlock Text="{Binding Name}" FontSize="{DynamicResource Font.SizeBody}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding Description}" FontSize="{DynamicResource Font.SizeCaption}"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" />
                      </StackPanel>
                    </Panel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </DockPanel>
          </Panel>

          <!-- ── 3: Lumis sidebar ── -->
          <Panel x:Name="SidebarAgents" IsVisible="False" DataContext="{Binding AgentsVM}" x:DataType="vm:AgentsViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="7,5" MinHeight="0"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Command="{Binding NewAgentCommand}" ToolTip.Tip="{loc:Str Sidebar_NewLumiTooltip}">
                  <PathIcon Data="{StaticResource Icon.Plus}" Width="14" Height="14"
                            Foreground="{DynamicResource Brush.TextSecondary}" />
                </Button>
                <TextBlock Text="{loc:Str Sidebar_Lumis}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="8,8,8,8"
                       ItemsSource="{Binding Agents}"
                       SelectedItem="{Binding SelectedAgent, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="models:LumiAgent">
                    <Panel Background="Transparent">
                      <Panel.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="{loc:Str Menu_Delete}"
                                    Command="{Binding $parent[Window].DataContext.AgentsVM.DeleteAgentCommand}"
                                    CommandParameter="{Binding}">
                            <MenuItem.Icon>
                              <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                            </MenuItem.Icon>
                          </MenuItem>
                        </ContextMenu>
                      </Panel.ContextMenu>
                      <StackPanel Spacing="1">
                        <TextBlock Text="{Binding Name}" FontSize="{DynamicResource Font.SizeBody}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding Description}" FontSize="{DynamicResource Font.SizeCaption}"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" />
                      </StackPanel>
                    </Panel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </DockPanel>
          </Panel>

          <!-- ── 4: Memories sidebar ── -->
          <Panel x:Name="SidebarMemories" IsVisible="False" DataContext="{Binding MemoriesVM}" x:DataType="vm:MemoriesViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="7,5" MinHeight="0"
                        CornerRadius="{DynamicResource Radius.Base}"
                        Command="{Binding NewMemoryCommand}" ToolTip.Tip="{loc:Str Sidebar_NewMemoryTooltip}">
                  <PathIcon Data="{StaticResource Icon.Plus}" Width="14" Height="14"
                            Foreground="{DynamicResource Brush.TextSecondary}" />
                </Button>
                <TextBlock Text="{loc:Str Sidebar_Memories}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="8,8,8,8"
                       ItemsSource="{Binding Memories}"
                       SelectedItem="{Binding SelectedMemory, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="models:Memory">
                    <Panel Background="Transparent">
                      <Panel.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="{loc:Str Menu_Delete}"
                                    Command="{Binding $parent[Window].DataContext.MemoriesVM.DeleteMemoryCommand}"
                                    CommandParameter="{Binding}">
                            <MenuItem.Icon>
                              <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                            </MenuItem.Icon>
                          </MenuItem>
                        </ContextMenu>
                      </Panel.ContextMenu>
                      <StackPanel Spacing="1">
                        <TextBlock Text="{Binding Key}" FontSize="{DynamicResource Font.SizeBody}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding Category}" FontSize="{DynamicResource Font.SizeCaption}"
                                   Foreground="{DynamicResource Brush.TextTertiary}"
                                   TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" />
                      </StackPanel>
                    </Panel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </DockPanel>
          </Panel>

          <!-- ── 5: MCP Servers sidebar ── -->
          <Panel x:Name="SidebarMcpServers" IsVisible="False" DataContext="{Binding McpServersVM}" x:DataType="vm:McpServersViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="2">
                  <Button Classes="subtle" Padding="7,5" MinHeight="0"
                          CornerRadius="{DynamicResource Radius.Base}"
                          Command="{Binding BrowseCatalogCommand}" ToolTip.Tip="{loc:Str Sidebar_BrowseMcpTooltip}">
                    <PathIcon Data="{StaticResource Icon.Browse}" Width="14" Height="14"
                              Foreground="{DynamicResource Brush.TextSecondary}" />
                  </Button>
                  <Button Classes="subtle" Padding="7,5" MinHeight="0"
                          CornerRadius="{DynamicResource Radius.Base}"
                          Command="{Binding NewServerCommand}" ToolTip.Tip="{loc:Str Sidebar_NewMcpServerTooltip}">
                    <PathIcon Data="{StaticResource Icon.Plus}" Width="14" Height="14"
                              Foreground="{DynamicResource Brush.TextSecondary}" />
                  </Button>
                </StackPanel>
                <TextBlock Text="{loc:Str Sidebar_McpServers}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_Search}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="8,8,8,8"
                       ItemsSource="{Binding Servers}"
                       SelectedItem="{Binding SelectedServer, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="models:McpServer">
                    <Panel Background="Transparent">
                      <Panel.ContextMenu>
                        <ContextMenu x:CompileBindings="False">
                          <MenuItem Header="{loc:Str Menu_Delete}"
                                    Command="{Binding $parent[Window].DataContext.McpServersVM.DeleteServerCommand}"
                                    CommandParameter="{Binding}">
                            <MenuItem.Icon>
                              <PathIcon Data="{StaticResource Icon.Trash}" Width="14" Height="14" />
                            </MenuItem.Icon>
                          </MenuItem>
                        </ContextMenu>
                      </Panel.ContextMenu>
                      <DockPanel>
                        <!-- Enabled indicator dot -->
                        <Ellipse DockPanel.Dock="Left" Width="6" Height="6"
                                 VerticalAlignment="Center" Margin="0,0,8,0"
                                 Fill="{DynamicResource Brush.SuccessDefault}"
                                 IsVisible="{Binding IsEnabled}" />
                        <Ellipse DockPanel.Dock="Left" Width="6" Height="6"
                                 VerticalAlignment="Center" Margin="0,0,8,0"
                                 Fill="{DynamicResource Brush.TextTertiary}" Opacity="0.4"
                                 IsVisible="{Binding !IsEnabled}" />
                        <StackPanel Spacing="1">
                          <TextBlock Text="{Binding Name}" FontSize="{DynamicResource Font.SizeBody}"
                                     TextTrimming="CharacterEllipsis" />
                          <TextBlock Text="{Binding Description}" FontSize="{DynamicResource Font.SizeCaption}"
                                     Foreground="{DynamicResource Brush.TextTertiary}"
                                     TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" />
                        </StackPanel>
                      </DockPanel>
                    </Panel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </DockPanel>
          </Panel>

          <!-- ── 6: Settings sidebar ── -->
          <Panel x:Name="SidebarSettings" IsVisible="False" DataContext="{Binding SettingsVM}" x:DataType="vm:SettingsViewModel">
            <DockPanel>
              <DockPanel DockPanel.Dock="Top" Margin="16,4,16,0">
                <TextBlock Text="{loc:Str Sidebar_Settings}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" Margin="6,0,0,0" />
              </DockPanel>
              <Border DockPanel.Dock="Top" Margin="16,6,16,0">
                <TextBox Watermark="{loc:Str Sidebar_SearchSettings}" Text="{Binding SearchQuery}"
                         Padding="6,5,8,5" FontSize="{DynamicResource Font.SizeCaption}">
                  <TextBox.InnerLeftContent>
                    <PathIcon Data="{StaticResource Icon.Search}" Width="12" Height="12"
                              Foreground="{DynamicResource Brush.TextTertiary}"
                              Margin="4,0,4,0" />
                  </TextBox.InnerLeftContent>
                </TextBox>
              </Border>
              <ListBox Classes="sidebar-list" Margin="14,12,14,8"
                       SelectedIndex="{Binding SelectedPageIndex, Mode=TwoWay}"
                       SelectionMode="Single">
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextSecondary}">
                      <PathIcon.Data>
                        <StreamGeometry>M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z</StreamGeometry>
                      </PathIcon.Data>
                    </PathIcon>
                    <TextBlock Text="{loc:Str Settings_Profile}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextSecondary}">
                      <PathIcon.Data>
                        <StreamGeometry>M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm-1-8h2l.4 2.2a8 8 0 0 1 2.3 1.3l2.1-.8 1 1.7-1.7 1.4a8 8 0 0 1 0 2.4l1.7 1.4-1 1.7-2.1-.8a8 8 0 0 1-2.3 1.3L13 22h-2l-.4-2.2a8 8 0 0 1-2.3-1.3l-2.1.8-1-1.7 1.7-1.4a8 8 0 0 1 0-2.4L5.2 12.4l1-1.7 2.1.8a8 8 0 0 1 2.3-1.3L11 8z</StreamGeometry>
                      </PathIcon.Data>
                    </PathIcon>
                    <TextBlock Text="{loc:Str Settings_General}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextSecondary}">
                      <PathIcon.Data>
                        <StreamGeometry>M12 3a9 9 0 1 0 0 18c.7 0 1.4-.1 2-.2a1 1 0 0 0 .7-1.5 3 3 0 0 1 2.4-4.8H18a3 3 0 0 0 3-3A9 9 0 0 0 12 3zM7.5 12a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm2-4a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm2 4a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z</StreamGeometry>
                      </PathIcon.Data>
                    </PathIcon>
                    <TextBlock Text="{loc:Str Settings_Appearance}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Data="{StaticResource Icon.Chat}" Width="14" Height="14"
                              Foreground="{DynamicResource Brush.TextSecondary}" />
                    <TextBlock Text="{loc:Str Settings_Chat}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Data="{StaticResource Icon.Sparkle}" Width="14" Height="14"
                              Foreground="{DynamicResource Brush.TextSecondary}" />
                    <TextBlock Text="{loc:Str Settings_AIModels}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextSecondary}">
                      <PathIcon.Data>
                        <StreamGeometry>M12 1L3 5v6c0 5.6 3.8 10.7 9 12 5.2-1.3 9-6.4 9-12V5l-9-4zm0 3.2L18 7v4c0 4.2-2.8 8-6 9.2C8.8 19 6 15.2 6 11V7l6-2.8z</StreamGeometry>
                      </PathIcon.Data>
                    </PathIcon>
                    <TextBlock Text="{loc:Str Settings_PrivacyData}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
                <ListBoxItem>
                  <StackPanel Orientation="Horizontal" Spacing="10">
                    <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextSecondary}">
                      <PathIcon.Data>
                        <StreamGeometry>M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 3a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm2 12h-4v-1h1v-5h-1v-1h3v6h1v1z</StreamGeometry>
                      </PathIcon.Data>
                    </PathIcon>
                    <TextBlock Text="{loc:Str Settings_About}" FontSize="{DynamicResource Font.SizeBody}" VerticalAlignment="Center" />
                  </StackPanel>
                </ListBoxItem>
              </ListBox>
            </DockPanel>
          </Panel>

          </Panel><!-- end sidebar content wrapper -->
        </DockPanel>
      </Border>

      <!-- ═══ CONTENT AREA (full height, inset for title bar) ═══ -->
      <Border x:Name="ContentArea" Margin="0,0,6,6" Padding="{StaticResource MainLayout.IslandOuterMargin}">
      <Grid>
        <!-- Chat view (visible on Chat tab) — wrapped in Grid for browser split -->
        <Grid x:Name="ChatContentGrid" ColumnDefinitions="1*,Auto,0">
            <Border x:Name="ChatIsland" Grid.Column="0"
              MinWidth="{StaticResource MainLayout.SplitIslandMinWidth}"
              MaxWidth="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=Grid}}"
                  FlowDirection="{Binding FlowDirection, RelativeSource={RelativeSource AncestorType=Window}}"
                  CornerRadius="{DynamicResource Radius.Overlay}"
                  Background="{DynamicResource Brush.SurfaceCard}"
                  BorderBrush="{DynamicResource Brush.BorderSubtle}"
                  BorderThickness="1"
                  BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000"
                  ClipToBounds="True">
            <views:ChatView x:Name="PageChat" DataContext="{Binding ChatVM}" />
          </Border>

          <!-- Drag splitter between chat and browser (hidden by default) -->
          <GridSplitter x:Name="BrowserSplitter" Grid.Column="1" IsVisible="False"
                        Width="6" Background="Transparent"
                        ResizeDirection="Columns" />

          <!-- Browser panel (hidden by default, shown when browser tools are active) -->
            <Border x:Name="BrowserIsland" Grid.Column="2" IsVisible="False"
              MinWidth="{StaticResource MainLayout.SplitIslandMinWidth}"
              MaxWidth="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=Grid}}"
                  CornerRadius="{DynamicResource Radius.Overlay}"
                  Background="{DynamicResource Brush.SurfaceCard}"
                  BorderBrush="{DynamicResource Brush.BorderSubtle}"
                  BorderThickness="1"
                  BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000"
                  ClipToBounds="True">
            <DockPanel>
              <!-- Browser header bar -->
              <DockPanel DockPanel.Dock="Top" Margin="12,8,12,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="6" MinHeight="0" MinWidth="0"
                        ToolTip.Tip="Close browser" x:Name="CloseBrowserButton">
                  <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextPrimary}">
                    <PathIcon.Data>
                      <StreamGeometry>M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z</StreamGeometry>
                    </PathIcon.Data>
                  </PathIcon>
                </Button>
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                  <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.AccentDefault}">
                    <PathIcon.Data>
                      <StreamGeometry>M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1 4h2v2h-2V6zm0 4h2v8h-2v-8z</StreamGeometry>
                    </PathIcon.Data>
                  </PathIcon>
                  <TextBlock Text="Browser" Classes="body-strong" FontWeight="SemiBold" />
                </StackPanel>
              </DockPanel>
              <ContentControl x:Name="BrowserHost" />
            </DockPanel>
          </Border>

          <!-- Diff preview panel (hidden by default, shown when clicking file-edit tool calls) -->
            <Border x:Name="DiffIsland" Grid.Column="2" IsVisible="False"
              MinWidth="{StaticResource MainLayout.SplitIslandMinWidth}"
              MaxWidth="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=Grid}}"
                  CornerRadius="{DynamicResource Radius.Overlay}"
                  Background="{DynamicResource Brush.SurfaceCard}"
                  BorderBrush="{DynamicResource Brush.BorderSubtle}"
                  BorderThickness="1"
                  BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000"
                  ClipToBounds="True">
            <DockPanel>
              <!-- Diff header bar -->
              <DockPanel DockPanel.Dock="Top" Margin="12,8,12,0">
                <Button DockPanel.Dock="Right" Classes="subtle" Padding="6" MinHeight="0" MinWidth="0"
                        ToolTip.Tip="Close diff" x:Name="CloseDiffButton">
                  <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextPrimary}">
                    <PathIcon.Data>
                      <StreamGeometry>M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z</StreamGeometry>
                    </PathIcon.Data>
                  </PathIcon>
                </Button>
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                  <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.AccentDefault}">
                    <PathIcon.Data>
                      <StreamGeometry>M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z</StreamGeometry>
                    </PathIcon.Data>
                  </PathIcon>
                  <TextBlock x:Name="DiffFileNameText" Text="Changes" Classes="body-strong" FontWeight="SemiBold" />
                </StackPanel>
              </DockPanel>
              <ContentControl x:Name="DiffHost" />
            </DockPanel>
          </Border>
        </Grid>

        <!-- ── Full-width pages with island treatment (visible when not on Chat tab) ── -->
        <Border x:Name="PageProjects" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageProjectsHost" />
        </Border>
        <Border x:Name="PageSkills" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageSkillsHost" />
        </Border>
        <Border x:Name="PageAgents" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageAgentsHost" />
        </Border>
        <Border x:Name="PageMemories" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageMemoriesHost" />
        </Border>
        <Border x:Name="PageMcpServers" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageMcpServersHost" />
        </Border>
        <Border x:Name="PageSettings" IsVisible="False"
                CornerRadius="{DynamicResource Radius.Overlay}"
                Background="{DynamicResource Brush.SurfaceCard}"
                BorderBrush="{DynamicResource Brush.BorderSubtle}" BorderThickness="1"
                BoxShadow="0 0 24 0 #1A000000, 0 0 4 0 #08000000" ClipToBounds="True">
          <ContentControl x:Name="PageSettingsHost" />
        </Border>
      </Grid>
      </Border>
    </DockPanel>

    <!-- ═══ Rename Dialog Overlay ═══ -->
    <Panel x:Name="RenameOverlay" IsVisible="False">
      <Border Background="#40000000" />
      <Border HorizontalAlignment="Center" VerticalAlignment="Center"
              Classes="strata-dialog" Padding="24,20" MinWidth="320" MaxWidth="400">
        <StackPanel Spacing="14">
          <TextBlock Text="{loc:Str Dialog_RenameChat}" FontSize="{DynamicResource Font.SizeBody}" FontWeight="SemiBold" />
          <TextBox x:Name="RenameTextBox"
                   Text="{Binding RenamingTitle, Mode=TwoWay}"
                   Watermark="{loc:Str Dialog_ChatTitle}" FontSize="{DynamicResource Font.SizeBody}" />
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="subtle" Content="{loc:Str Common_Cancel}" Padding="14,6" MinHeight="0"
                    Command="{Binding CancelRenameChatCommand}" />
            <Button Classes="accent" Content="{loc:Str Common_Rename}" Padding="14,6" MinHeight="0"
                    Command="{Binding CommitRenameChatCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Panel>
  </Panel>
  </Border>
</Window>
