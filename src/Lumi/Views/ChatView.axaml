<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lumi.ViewModels"
             xmlns:sc="using:StrataTheme.Controls"
             xmlns:loc="using:Lumi.Localization"
             x:Class="Lumi.Views.ChatView"
             x:CompileBindings="False">

  <UserControl.Styles>
    <!-- Show Retry on user messages (theme hides it) -->
    <Style Selector="sc|StrataChatMessage:user /template/ Button#PART_RegenerateButton">
      <Setter Property="IsVisible" Value="True" />
    </Style>
    <!-- Hide Retry on assistant messages -->
    <Style Selector="sc|StrataChatMessage:assistant /template/ Button#PART_RegenerateButton">
      <Setter Property="IsVisible" Value="False" />
    </Style>
  </UserControl.Styles>

  <Panel>
    <!-- Welcome state (no active chat) -->
    <Panel x:Name="WelcomePanel">
      <!-- Centered greeting (offset up to leave room for composer) -->
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16"
                  MaxWidth="480" Margin="0,0,0,120">
        <Border x:Name="WelcomeOrb" Width="64" Height="64" CornerRadius="14"
                HorizontalAlignment="Center" Opacity="0.9" ClipToBounds="True">
          <Image Source="avares://Lumi/Assets/lumi-icon.png"
                 Width="64" Height="64"
                 RenderOptions.BitmapInterpolationMode="HighQuality" />
        </Border>

        <StackPanel Spacing="6" HorizontalAlignment="Center">
          <TextBlock Classes="headline" Text="{loc:Str Chat_WelcomeTitle}"
                     HorizontalAlignment="Center" />
          <TextBlock Classes="secondary" TextAlignment="Center" TextWrapping="Wrap"
                     Text="{loc:Str Chat_WelcomeSubtitle}" />
        </StackPanel>
      </StackPanel>

      <!-- Bottom-pinned composer -->
      <StackPanel VerticalAlignment="Bottom" Spacing="4" MaxWidth="680"
                  HorizontalAlignment="Stretch" Margin="24,0,24,20">
        <sc:StrataAttachmentList x:Name="WelcomePendingAttachmentList"
                                 ShowAddButton="False"
                                 IsVisible="False" />
        <sc:StrataChatComposer x:Name="WelcomeComposer"
                               Placeholder="{loc:Str Chat_Placeholder}"
                               PromptText="{Binding PromptText, Mode=TwoWay}"
                               IsBusy="{Binding IsBusy}"
                               Models="{Binding AvailableModels}"
                               SelectedModel="{Binding SelectedModel, Mode=TwoWay}"
                               QualityLevels="{x:Null}"
                               SuggestionA="{loc:Str Chat_SuggestionA}"
                               SuggestionB="{loc:Str Chat_SuggestionB}"
                               SuggestionC="{loc:Str Chat_SuggestionC}"
                               SkillItems="{Binding ActiveSkillChips}" />
      </StackPanel>
    </Panel>

    <!-- Active chat -->
    <Panel x:Name="ChatPanel" IsVisible="False">
      <sc:StrataChatShell x:Name="ChatShell" IsOnline="True">

        <sc:StrataChatShell.Header>
          <DockPanel Margin="0,0,8,0">
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8"
                        VerticalAlignment="Center">
              <Border x:Name="ProjectBadge" IsVisible="False"
                      Background="{DynamicResource Brush.SurfaceSubtle}" CornerRadius="12" Padding="10,4">
                <TextBlock x:Name="ProjectBadgeText" Classes="caption" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}" />
              </Border>
              <Border x:Name="AgentBadge" IsVisible="False"
                      Background="{DynamicResource Brush.AccentSubtle}" CornerRadius="12" Padding="10,4">
                <TextBlock x:Name="AgentBadgeText" Classes="caption" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.AccentDefault}" />
              </Border>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
              <Border Width="26" Height="26" CornerRadius="7"
                      Background="{DynamicResource Brush.AccentGradient}">
                <TextBlock Text="{loc:Str Chat_AvatarLetter}" FontSize="12" FontWeight="Bold"
                           Foreground="{DynamicResource Brush.TextOnAccent}"
                           HorizontalAlignment="Center" VerticalAlignment="Center" />
              </Border>
              <TextBlock Classes="body-strong" Text="{Binding CurrentChat.Title}"
                         TextTrimming="CharacterEllipsis" />
            </StackPanel>
          </DockPanel>
        </sc:StrataChatShell.Header>

        <sc:StrataChatShell.Transcript>
          <ItemsControl ItemsSource="{Binding Messages}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Panel Margin="0,4" />
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </sc:StrataChatShell.Transcript>

        <sc:StrataChatShell.Composer>
          <StackPanel Spacing="4">
            <sc:StrataAttachmentList x:Name="PendingAttachmentList"
                                     ShowAddButton="False"
                                     IsVisible="False" />
            <sc:StrataChatComposer x:Name="ActiveComposer"
                                  Placeholder="{loc:Str Chat_Placeholder}"
                                  PromptText="{Binding PromptText, Mode=TwoWay}"
                                  IsBusy="{Binding IsBusy}"
                                  Models="{Binding AvailableModels}"
                                  SelectedModel="{Binding SelectedModel, Mode=TwoWay}"
                                  QualityLevels="{x:Null}"
                                  SkillItems="{Binding ActiveSkillChips}" />
          </StackPanel>
        </sc:StrataChatShell.Composer>

      </sc:StrataChatShell>
    </Panel>
  </Panel>
</UserControl>
