<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lumi.ViewModels"
             xmlns:sc="using:StrataTheme.Controls"
             xmlns:loc="using:Lumi.Localization"
             x:Class="Lumi.Views.ChatView"
             x:DataType="vm:ChatViewModel"
             x:CompileBindings="True">

  <UserControl.Styles>
    <!-- Show Retry on user messages (theme hides it) -->
    <Style Selector="sc|StrataChatMessage:user /template/ Button#PART_RegenerateButton">
      <Setter Property="IsVisible" Value="True" />
    </Style>
    <!-- Hide entire action toolbar on assistant messages -->
    <Style Selector="sc|StrataChatMessage:assistant /template/ Border#PART_ActionLayer">
      <Setter Property="IsVisible" Value="False" />
    </Style>
  </UserControl.Styles>

  <Panel DragDrop.AllowDrop="True">
    <!-- Drop overlay -->
    <Panel x:Name="DropOverlay" IsVisible="False" IsHitTestVisible="False"
           ZIndex="100">
      <!-- Dimming backdrop -->
      <Border Background="{DynamicResource Brush.Surface0}" Opacity="0.85" />
      <!-- Accent border inset -->
      <Border Margin="16" CornerRadius="12" BorderThickness="2"
              BorderBrush="{DynamicResource Brush.AccentDefault}" />
      <!-- Centered content -->
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
        <Border Width="56" Height="56" CornerRadius="28"
                Background="{DynamicResource Brush.AccentSubtle}"
                HorizontalAlignment="Center">
          <Viewbox Width="24" Height="24" HorizontalAlignment="Center" VerticalAlignment="Center">
            <Canvas Width="24" Height="24">
              <!-- Upload/drop arrow icon -->
              <Path Stroke="{DynamicResource Brush.AccentDefault}"
                    StrokeThickness="2.2" StrokeLineCap="Round"
                    Data="M12,2 L12,16 M12,2 L7,7 M12,2 L17,7" />
              <Path Stroke="{DynamicResource Brush.AccentDefault}"
                    StrokeThickness="2.2" StrokeLineCap="Round"
                    Data="M4,17 L4,20 C4,21.1 4.9,22 6,22 L18,22 C19.1,22 20,21.1 20,20 L20,17" />
            </Canvas>
          </Viewbox>
        </Border>
        <StackPanel Spacing="4" HorizontalAlignment="Center">
          <TextBlock Text="{loc:Str DragDrop_Hint}" Classes="body-strong" FontSize="15"
                     Foreground="{DynamicResource Brush.AccentDefault}"
                     HorizontalAlignment="Center" />
          <TextBlock Text="{loc:Str DragDrop_Subhint}" Classes="caption"
                     Foreground="{DynamicResource Brush.TextTertiary}"
                     HorizontalAlignment="Center" />
        </StackPanel>
      </StackPanel>
    </Panel>

    <!-- Welcome state (no active chat) -->
    <Panel x:Name="WelcomePanel">
      <!-- Centered greeting (offset up to leave room for composer) -->
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16"
                  MaxWidth="480" Margin="0,0,0,120">
        <Border x:Name="WelcomeOrb" Width="64" Height="64" CornerRadius="14"
                HorizontalAlignment="Center" Opacity="0.9" ClipToBounds="True">
          <Image Source="avares://Lumi/Assets/lumi-icon.png"
                 Width="64" Height="64"
                 RenderOptions.BitmapInterpolationMode="HighQuality" />
        </Border>

        <StackPanel Spacing="6" HorizontalAlignment="Center">
          <TextBlock Classes="headline" Text="{loc:Str Chat_WelcomeTitle}"
                     HorizontalAlignment="Center" />
          <TextBlock Classes="secondary" TextAlignment="Center" TextWrapping="Wrap"
                     Text="{loc:Str Chat_WelcomeSubtitle}" />
        </StackPanel>
      </StackPanel>

      <!-- Bottom-pinned composer -->
      <StackPanel VerticalAlignment="Bottom" Spacing="4" MaxWidth="680"
                  HorizontalAlignment="Stretch" Margin="24,0,24,20">
        <sc:StrataAttachmentList x:Name="WelcomePendingAttachmentList"
                                 ShowAddButton="False"
                                 IsVisible="False" />
        <sc:StrataChatComposer x:Name="WelcomeComposer"
                               Placeholder="{loc:Str Chat_Placeholder}"
                               PromptText="{Binding PromptText, Mode=TwoWay}"
                               IsBusy="{Binding IsBusy}"
                               Models="{Binding AvailableModels}"
                               SelectedModel="{Binding SelectedModel, Mode=TwoWay}"
                               QualityLevels="{x:Null}"
                               SuggestionA="{loc:Str Chat_SuggestionA}"
                               SuggestionB="{loc:Str Chat_SuggestionB}"
                               SuggestionC="{loc:Str Chat_SuggestionC}"
                               SkillItems="{Binding ActiveSkillChips}"
                               McpItems="{Binding ActiveMcpChips}" />
      </StackPanel>
    </Panel>

    <!-- Active chat -->
    <Panel x:Name="ChatPanel" IsVisible="False">
      <!-- Loading overlay shown while chat history is being rebuilt -->
      <Panel x:Name="LoadingOverlay" IsVisible="False" ZIndex="50">
        <Border Background="{DynamicResource Brush.Surface0}" Opacity="0.85" />
        <sc:StrataTypingIndicator x:Name="LoadingIndicator"
                                  Label="{loc:Str Chat_Loading}"
                                  IsActive="True"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center" />
      </Panel>
      <sc:StrataChatShell x:Name="ChatShell" IsOnline="True">

        <sc:StrataChatShell.Header>
          <DockPanel Margin="0,0,8,0">
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="6"
                        VerticalAlignment="Center" Margin="8,0,0,0">
              <Border x:Name="ProjectBadge" IsVisible="False"
                      Background="{DynamicResource Brush.SurfaceSubtle}" CornerRadius="12" Padding="10,4">
                <TextBlock x:Name="ProjectBadgeText" Classes="caption" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.TextSecondary}" />
              </Border>
              <Border x:Name="AgentBadge" IsVisible="False"
                      Background="{DynamicResource Brush.AccentSubtle}" CornerRadius="12" Padding="10,4">
                <TextBlock x:Name="AgentBadgeText" Classes="caption" FontWeight="SemiBold"
                           Foreground="{DynamicResource Brush.AccentDefault}" />
              </Border>
              <Button x:Name="BrowserToggleButton" Classes="subtle" IsVisible="False"
                      ToolTip.Tip="{loc:Str Browser_ShowBrowser}"
                      Padding="7,4" CornerRadius="12">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <PathIcon Width="12" Height="12"
                            Foreground="{DynamicResource Brush.TextSecondary}"
                            Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                  <TextBlock x:Name="BrowserToggleText" Classes="caption" FontWeight="SemiBold"
                             Foreground="{DynamicResource Brush.TextSecondary}" Text="Browser" />
                </StackPanel>
              </Button>
            </StackPanel>
            <!-- Avatar is fixed, title fills remaining space and trims -->
            <Border DockPanel.Dock="Left" Width="26" Height="26" CornerRadius="7"
                    Background="{DynamicResource Brush.AccentGradient}" Margin="0,0,10,0">
              <TextBlock Text="{loc:Str Chat_AvatarLetter}" FontSize="12" FontWeight="Bold"
                         Foreground="{DynamicResource Brush.TextOnAccent}"
                         HorizontalAlignment="Center" VerticalAlignment="Center" />
            </Border>
            <TextBlock Classes="body-strong" Text="{Binding CurrentChatTitle}"
                       ToolTip.Tip="{Binding CurrentChatTitle}"
                       TextTrimming="CharacterEllipsis" VerticalAlignment="Center" />
          </DockPanel>
        </sc:StrataChatShell.Header>

        <sc:StrataChatShell.Transcript>
          <ItemsControl ItemsSource="{Binding Messages}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Panel Margin="0,4" />
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </sc:StrataChatShell.Transcript>

        <sc:StrataChatShell.Composer>
          <StackPanel Spacing="4">
            <sc:StrataAttachmentList x:Name="PendingAttachmentList"
                                     ShowAddButton="False"
                                     IsVisible="False" />
            <sc:StrataChatComposer x:Name="ActiveComposer"
                                  Placeholder="{loc:Str Chat_Placeholder}"
                                  PromptText="{Binding PromptText, Mode=TwoWay}"
                                  IsBusy="{Binding IsBusy}"
                                  Models="{Binding AvailableModels}"
                                  SelectedModel="{Binding SelectedModel, Mode=TwoWay}"
                                  QualityLevels="{x:Null}"
                                  SuggestionA="{Binding SuggestionA}"
                                  SuggestionB="{Binding SuggestionB}"
                                  SuggestionC="{Binding SuggestionC}"
                                  IsSuggestionsGenerating="{Binding IsSuggestionsGenerating}"
                                  SkillItems="{Binding ActiveSkillChips}"
                                  McpItems="{Binding ActiveMcpChips}" />
          </StackPanel>
        </sc:StrataChatShell.Composer>

      </sc:StrataChatShell>
    </Panel>
  </Panel>
</UserControl>
