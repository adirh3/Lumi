<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Lumi.ViewModels"
             xmlns:sc="using:StrataTheme.Controls"
             xmlns:loc="using:Lumi.Localization"
             x:Class="Lumi.Views.SettingsView"
             x:DataType="vm:SettingsViewModel"
             x:CompileBindings="True">

  <Panel>

    <!-- ═══ Restart banner (shown when a restart-required setting changes) ═══ -->
    <Border x:Name="RestartBanner"
            IsVisible="{Binding NeedsRestart}"
            Background="{DynamicResource Brush.WarningSubtle}"
            CornerRadius="8" Padding="16,10" Margin="36,24,36,0"
            MaxWidth="560" HorizontalAlignment="Left"
            VerticalAlignment="Top" ZIndex="10">
      <DockPanel>
        <Button DockPanel.Dock="Right" Classes="accent" Content="{loc:Str Settings_Restart}"
                Padding="14,6" MinHeight="0" Margin="12,0,0,0"
                Command="{Binding RestartAppCommand}" />
        <TextBlock Text="{loc:Str Settings_RestartBanner}"
                   VerticalAlignment="Center" FontSize="{DynamicResource Font.SizeCaption}"
                   Foreground="{DynamicResource Brush.TextPrimary}" />
      </DockPanel>
    </Border>

    <ScrollViewer x:Name="MainScrollViewer" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
    <StackPanel x:Name="AllPagesStack" Spacing="0">

    <!-- Search results header (shown during search) -->
    <DockPanel x:Name="SearchResultsHeader" IsVisible="False"
              Margin="36,24,36,4" MaxWidth="560" HorizontalAlignment="Left">
      <Button x:Name="ClearSearchButton" DockPanel.Dock="Right" Classes="subtle"
              Content="{loc:Str Common_Clear}" Padding="8,4" MinHeight="0" MinWidth="0"
              FontSize="{DynamicResource Font.SizeCaption}"
              Foreground="{DynamicResource Brush.AccentDefault}"
              VerticalAlignment="Center" />
      <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
        <PathIcon Width="14" Height="14" Foreground="{DynamicResource Brush.TextTertiary}">
          <PathIcon.Data>
            <StreamGeometry>M10 3a7 7 0 1 0 4.2 12.6l4.1 4.1a1 1 0 0 0 1.4-1.4l-4.1-4.1A7 7 0 0 0 10 3zm-5 7a5 5 0 1 1 10 0 5 5 0 0 1-10 0z</StreamGeometry>
          </PathIcon.Data>
        </PathIcon>
        <StackPanel Orientation="Horizontal" Spacing="0">
          <TextBlock x:Name="SearchCountText" FontSize="13" FontWeight="SemiBold"
                     Foreground="{DynamicResource Brush.AccentDefault}" />
          <TextBlock x:Name="SearchQueryText" FontSize="13"
                     Foreground="{DynamicResource Brush.TextSecondary}" />
        </StackPanel>
      </StackPanel>
    </DockPanel>

    <!-- ═══ Page 0: Profile ═══ -->
      <StackPanel x:Name="PageProfile" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_Profile}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_ProfileDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Profile}">
          <sc:StrataSetting Header="{loc:Str Setting_YourName}" Description="{loc:Str SettingDesc_YourName}">
            <TextBox Text="{Binding UserName}" Watermark="{loc:Str Watermark_EnterName}" Width="220" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_Sex}" Description="{loc:Str SettingDesc_Sex}">
            <ComboBox x:Name="SettingsSexCombo" Width="220"
                      SelectedIndex="{Binding UserSexIndex}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Language}">
          <sc:StrataSetting Header="{loc:Str Setting_Language}" Description="{loc:Str SettingDesc_Language}">
            <ComboBox ItemsSource="{Binding LanguageOptions}"
                      SelectedItem="{Binding SelectedLanguage, Mode=TwoWay}"
                      Width="200" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 1: General ═══ -->
      <StackPanel x:Name="PageGeneral" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_General}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_GeneralDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Startup}">
          <sc:StrataSetting Header="{loc:Str Setting_LaunchAtStartup}" Description="{loc:Str SettingDesc_LaunchAtStartup}"
                            IsModified="{Binding IsLaunchAtStartupModified}">
            <ToggleSwitch IsChecked="{Binding LaunchAtStartup}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_StartMinimized}" Description="{loc:Str SettingDesc_StartMinimized}"
                            IsModified="{Binding IsStartMinimizedModified}">
            <ToggleSwitch IsChecked="{Binding StartMinimized}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_MinimizeToTray}" Description="{loc:Str SettingDesc_MinimizeToTray}"
                            IsModified="{Binding IsMinimizeToTrayModified}">
            <ToggleSwitch IsChecked="{Binding MinimizeToTray}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Notifications}">
          <sc:StrataSetting Header="{loc:Str Setting_EnableNotifications}" Description="{loc:Str SettingDesc_EnableNotifications}"
                            IsModified="{Binding IsNotificationsEnabledModified}">
            <ToggleSwitch IsChecked="{Binding NotificationsEnabled}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Keyboard}">
          <sc:StrataSetting Header="{loc:Str Setting_GlobalHotkey}" Description="{loc:Str SettingDesc_GlobalHotkey}"
                            IsModified="{Binding IsGlobalHotkeyModified}">
            <Button x:Name="HotkeyRecorderButton" Classes="subtle" Padding="14,6" MinHeight="0"
                    MinWidth="120" HorizontalContentAlignment="Center"
                    FontSize="{DynamicResource Font.SizeCaption}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 2: Appearance ═══ -->
      <StackPanel x:Name="PageAppearance" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_Appearance}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_AppearanceDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Theme}">
          <sc:StrataSetting Header="{loc:Str Setting_DarkMode}" Description="{loc:Str SettingDesc_DarkMode}"
                            IsModified="{Binding IsDarkThemeModified}">
            <ToggleSwitch IsChecked="{Binding IsDarkTheme}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Layout}">
          <sc:StrataSetting Header="{loc:Str Setting_CompactDensity}" Description="{loc:Str SettingDesc_CompactDensity}"
                            IsModified="{Binding IsCompactDensityModified}">
            <ToggleSwitch IsChecked="{Binding IsCompactDensity}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_FontSize}" Description="{loc:Str SettingDesc_FontSize}"
                            IsModified="{Binding IsFontSizeModified}">
            <StackPanel Orientation="Horizontal" Spacing="12">
              <Slider Minimum="11" Maximum="18" Value="{Binding FontSize}"
                      TickFrequency="1" IsSnapToTickEnabled="True" Width="140" />
              <TextBlock Text="{Binding FontSize, StringFormat='{}{0}px'}"
                         VerticalAlignment="Center" FontSize="{DynamicResource Font.SizeCaption}"
                         Foreground="{DynamicResource Brush.TextSecondary}" MinWidth="32" />
            </StackPanel>
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Motion}">
          <sc:StrataSetting Header="{loc:Str Setting_ShowAnimations}" Description="{loc:Str SettingDesc_ShowAnimations}"
                            IsModified="{Binding IsShowAnimationsModified}">
            <ToggleSwitch IsChecked="{Binding ShowAnimations}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 3: Chat ═══ -->
      <StackPanel x:Name="PageChat" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_Chat}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_ChatDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Input}">
          <sc:StrataSetting Header="{loc:Str Setting_SendWithEnter}" Description="{loc:Str SettingDesc_SendWithEnter}"
                            IsModified="{Binding IsSendWithEnterModified}">
            <ToggleSwitch IsChecked="{Binding SendWithEnter}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Display}">
          <sc:StrataSetting Header="{loc:Str Setting_ShowTimestamps}" Description="{loc:Str SettingDesc_ShowTimestamps}"
                            IsModified="{Binding IsShowTimestampsModified}">
            <ToggleSwitch IsChecked="{Binding ShowTimestamps}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_ShowToolCalls}" Description="{loc:Str SettingDesc_ShowToolCalls}"
                            IsModified="{Binding IsShowToolCallsModified}">
            <ToggleSwitch IsChecked="{Binding ShowToolCalls}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_ShowReasoning}" Description="{loc:Str SettingDesc_ShowReasoning}"
                            IsModified="{Binding IsShowReasoningModified}">
            <ToggleSwitch IsChecked="{Binding ShowReasoning}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Behavior}">
          <sc:StrataSetting Header="{loc:Str Setting_AutoGenerateTitles}" Description="{loc:Str SettingDesc_AutoGenerateTitles}"
                            IsModified="{Binding IsAutoGenerateTitlesModified}">
            <ToggleSwitch IsChecked="{Binding AutoGenerateTitles}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_MaxContextMessages}" Description="{loc:Str SettingDesc_MaxContextMessages}"
                            IsModified="{Binding IsMaxContextMessagesModified}">
            <StackPanel Orientation="Horizontal" Spacing="12">
              <Slider Minimum="10" Maximum="100" Value="{Binding MaxContextMessages}"
                      TickFrequency="10" IsSnapToTickEnabled="True" Width="140" />
              <TextBlock Text="{Binding MaxContextMessages}"
                         VerticalAlignment="Center" FontSize="{DynamicResource Font.SizeCaption}"
                         Foreground="{DynamicResource Brush.TextSecondary}" MinWidth="24" />
            </StackPanel>
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 4: AI & Models ═══ -->
      <StackPanel x:Name="PageAI" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_AIModels}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_AIModelsDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_GitHubAccount}">
          <sc:StrataSetting Header="{loc:Str Setting_GitHubAccount}" Description="{loc:Str SettingDesc_GitHubAccount}">
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
              <!-- Signed-in state: green dot + username -->
              <StackPanel Orientation="Horizontal" Spacing="6"
                          IsVisible="{Binding IsAuthenticated}">
                <Border Width="6" Height="6" CornerRadius="3"
                        Background="{DynamicResource Brush.SuccessDefault}"
                        VerticalAlignment="Center" />
                <TextBlock Text="{Binding GitHubLogin}" FontSize="{DynamicResource Font.SizeCaption}"
                           Foreground="{DynamicResource Brush.TextSecondary}"
                           VerticalAlignment="Center" />
              </StackPanel>
              <!-- Not signed in: sign-in button -->
              <Button Classes="accent" Padding="14,6" MinHeight="0"
                      IsVisible="{Binding !IsAuthenticated}"
                      IsEnabled="{Binding !IsSigningIn}"
                      Command="{Binding SignInCommand}"
                      x:Name="SignInButton" />
            </StackPanel>
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Model}">
          <sc:StrataSetting Header="{loc:Str Setting_PreferredModel}" Description="{loc:Str SettingDesc_PreferredModel}"
                            IsModified="{Binding IsPreferredModelModified}">
            <ComboBox ItemsSource="{Binding AvailableModels}"
                      SelectedItem="{Binding PreferredModel, Mode=TwoWay}"
                      Width="220" IsEditable="True" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 5: Privacy & Data ═══ -->
      <StackPanel x:Name="PagePrivacy" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_PrivacyData}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_PrivacyDataDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Memory}">
          <sc:StrataSetting Header="{loc:Str Setting_AutoSaveMemories}" Description="{loc:Str SettingDesc_AutoSaveMemories}"
                            IsModified="{Binding IsEnableMemoryAutoSaveModified}">
            <ToggleSwitch IsChecked="{Binding EnableMemoryAutoSave}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_ChatHistory}">
          <sc:StrataSetting Header="{loc:Str Setting_AutoSaveChats}" Description="{loc:Str SettingDesc_AutoSaveChats}"
                            IsModified="{Binding IsAutoSaveChatsModified}">
            <ToggleSwitch IsChecked="{Binding AutoSaveChats}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_DataManagement}">
          <sc:StrataSetting Header="{loc:Str Setting_ClearAllChats}" Description="{loc:Str SettingDesc_ClearAllChats}">
            <Button Classes="subtle" Content="{loc:Str Button_ClearChats}" Padding="14,6" MinHeight="0"
                    Foreground="{DynamicResource Brush.DangerDefault}"
                    Command="{Binding ClearAllChatsCommand}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_ClearAllMemories}" Description="{loc:Str SettingDesc_ClearAllMemories}">
            <Button Classes="subtle" Content="{loc:Str Button_ClearMemories}" Padding="14,6" MinHeight="0"
                    Foreground="{DynamicResource Brush.DangerDefault}"
                    Command="{Binding ClearAllMemoriesCommand}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_ResetAllSettings}" Description="{loc:Str SettingDesc_ResetAllSettings}">
            <Button Classes="subtle" Content="{loc:Str Button_ResetDefaults}" Padding="14,6" MinHeight="0"
                    Command="{Binding ResetSettingsCommand}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    <!-- ═══ Page 6: About ═══ -->
      <StackPanel x:Name="PageAbout" IsVisible="False" Spacing="20" Margin="36,24,36,36" MaxWidth="560">
        <StackPanel Spacing="4">
          <TextBlock Text="{loc:Str Settings_About}" FontSize="{DynamicResource Font.SizeTitle}" FontWeight="SemiBold" />
          <TextBlock Text="{loc:Str Settings_AboutDesc}" FontSize="{DynamicResource Font.SizeCaption}"
                     Foreground="{DynamicResource Brush.TextTertiary}" />
        </StackPanel>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_App}">
          <sc:StrataSetting Header="{loc:Str Setting_Version}" Description="{loc:Str SettingDesc_Version}">
            <TextBlock Text="{Binding AppVersion, StringFormat='v{0}'}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_DotNetRuntime}">
            <TextBlock Text="{Binding DotNetVersion}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" TextTrimming="CharacterEllipsis" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_OperatingSystem}">
            <TextBlock Text="{Binding OsVersion}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" TextTrimming="CharacterEllipsis" />
          </sc:StrataSetting>
          <sc:StrataSetting x:Name="DebugTransparencySetting"
                            Header="Window Transparency (Debug)"
                            IsVisible="False">
            <TextBlock x:Name="DebugTransparencyValue"
                       FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}"
                       Text="Unavailable" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Statistics}">
          <sc:StrataSetting Header="{loc:Str Setting_TotalChats}">
            <TextBlock Text="{Binding TotalChats}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_TotalMemories}">
            <TextBlock Text="{Binding TotalMemories}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_StatsSkills}">
            <TextBlock Text="{Binding TotalSkills}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_StatsAgents}">
            <TextBlock Text="{Binding TotalAgents}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
          <sc:StrataSetting Header="{loc:Str Setting_StatsProjects}">
            <TextBlock Text="{Binding TotalProjects}" FontSize="{DynamicResource Font.SizeCaption}"
                       Foreground="{DynamicResource Brush.TextTertiary}" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>

        <sc:StrataSettingGroup Header="{loc:Str SettingsGroup_Credits}">
          <sc:StrataSetting Header="{loc:Str Setting_BuiltWith}"
                            Description="{loc:Str SettingDesc_BuiltWith}">
            <TextBlock Text="❤️" FontSize="16" />
          </sc:StrataSetting>
        </sc:StrataSettingGroup>
      </StackPanel>

    </StackPanel>
    </ScrollViewer>

    <!-- No results indicator -->
    <StackPanel x:Name="NoResultsPanel" IsVisible="False"
                VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
      <PathIcon Width="40" Height="40" Foreground="{DynamicResource Brush.TextTertiary}"
                HorizontalAlignment="Center">
        <PathIcon.Data>
          <StreamGeometry>M10 3a7 7 0 1 0 4.2 12.6l4.1 4.1a1 1 0 0 0 1.4-1.4l-4.1-4.1A7 7 0 0 0 10 3zm-5 7a5 5 0 1 1 10 0 5 5 0 0 1-10 0z</StreamGeometry>
        </PathIcon.Data>
      </PathIcon>
      <StackPanel Spacing="4" HorizontalAlignment="Center">
        <TextBlock x:Name="NoResultsQueryText" FontSize="{DynamicResource Font.SizeBody}"
                   Foreground="{DynamicResource Brush.TextSecondary}" HorizontalAlignment="Center" />
        <TextBlock Text="{loc:Str Settings_TryDifferentSearch}" FontSize="{DynamicResource Font.SizeCaption}"
                   Foreground="{DynamicResource Brush.TextTertiary}" HorizontalAlignment="Center" />
      </StackPanel>
      <Button x:Name="NoResultsClearButton" Classes="subtle" Content="{loc:Str Settings_ClearSearch}"
              Padding="12,6" MinHeight="0" HorizontalAlignment="Center"
              Foreground="{DynamicResource Brush.AccentDefault}" />
    </StackPanel>

  </Panel>
</UserControl>
